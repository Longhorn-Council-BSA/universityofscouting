<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: routes/api.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: routes/api.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * api router module
 *
 * This module allows for programatic download of transcript data.
 *
 * @module routes/api
 */
// jshint esversion: 8
// async functions
var express = require("express");
var router = express.Router();
var modelhelper = require("../lib/modelhelper");
var cap = require("../lib/capabilities");
var log = require("../lib/log");

/**
 * GET all members.
 *
 * Return all members in either JSON or CSV format.  JSON is returned by default.
 * If ?return=csv is provided in the query, a CSV will be provided.
 *
 * If the calling route provides req._id, then limit responses to just that
 * member, by _id.
 *
 * @private
 * @memberof module:routes/api
 * @param {Object}   req                request object
 * @param {Object}   req.user           user object to check against 'api' capability
 * @param {String}   req.params.id      limit to responses to a single member by _id
 * @param {String}   req.query.return   when set to "csv", return CSV output
 * @param {Object}   res                response object
 * @param {Function} next               function call to next middleware
 */
async function routeGETApiMembers(req, res, next) {
  log("routeGETApiMembers()");
  if (!cap.check(req.user, "api")) {
    log("routeGETApiMembers: denied: " + req.user.access);
    res.status(401).json({
      message: "You do not have permission to access this API",
    });
    return;
  }

  // query by _id if provided
  var q = {};
  if ("id" in req.params) {
    log("routeGETApiMembers: id: " + req.params.id);
    q._id = req.params.id;
  }

  //if no id filtering queries were provided and
  //if apiList access is not allowed, deny
  if(!('_id' in q) &amp;&amp; !cap.check(req.user, "apiList")) {
    log("routeGETApiMembers: list denied: " + req.user.access);
    res.status(401).json({
      message: "You do not have permission to access this API",
    });
    return;
  }

  try {
    if (req.query.return == "csv") {
      log("routeGETApiMembers: return csv");
      res.csv(await modelhelper.getMember(q));
    } else {
      log("routeGETApiMembers: return");
      res.json(await modelhelper.getMember(q));
    }
  } catch (err) {
    log("routeGETApiMembers: error");
    res.status(500).json({
      message: err.message,
    });
  }
}

/**
 * GET all registration entries.
 *
 * Return all registration entries in either JSON or CSV format.  JSON is returned by default.
 * If ?return=csv is provided in the query, a CSV will be provided.
 * @private
 * @memberof module:routes/api
 * @param {Object}   req                  request object
 * @param {Object}   req.user             user object to check against 'api' capability
 * @param {Date}     req.query.earliest   filters so that no objects are returned older than this time
 * @param {String}   req.query.return     when set to "csv", return CSV output
 * @param {Object}   res                  response object
 * @param {Function} next                 function call to next middleware
 */
async function routeGETApiRegistrations(req, res, next) {
  log("routeGETApiRegistrations()");
  //if api access is not allowed, deny
  if (!cap.check(req.user, "api")) {
    log("routeGETApiRegistrations: denied: " + req.user.access);
    res.status(401).json({
      message: "You do not have permission to access this API",
    });
    return;
  }

  // query by _id if provided
  var q = {};
  if ("id" in req.params) {
    log("routeGETApiRegistrations: id: " + req.params.id);
    q._id = req.params.id;

    // query by member_id if provided
  } else if ("memberid" in req.params) {
    log("routeGETApiRegistrations: memberid: " + req.params.memberid);
    q.member_id = req.params.memberid;
  }

  // query by earliest if provided
  if ("earliest" in req.query) {
    log("routeGETApiRegistrations: earliest: " + req.query.earliest);
    q.earliest = req.query.earliest;
  }

  //if no member or id filtering queries were provided and
  //if apiList access is not allowed, deny
  if(!('_id' in q || 'member_id' in q) &amp;&amp; !cap.check(req.user, "apiList")) {
    log("routeGETApiRegistrations: list denied: " + req.user.access);
    res.status(401).json({
      message: "You do not have permission to access this API",
    });
    return;
  }

  try {
    if (req.query.return == "csv") {
      log("routeGETApiRegistrations: return csv");
      res.csv(await modelhelper.getRegistration(q));
    } else {
      log("routeGETApiRegistrations: return");
      res.json(await modelhelper.getRegistration(q));
    }
  } catch (err) {
    log("routeGETApiRegistrations: error");
    res.status(500).json({
      message: err.message,
    });
  }
}

// register routes and export router
router.get("/members", routeGETApiMembers);
router.get("/members/:memberid/registrations", routeGETApiRegistrations);
router.get("/members/:id", routeGETApiMembers);
router.get("/registrations", routeGETApiRegistrations);
router.get("/registrations/:id", routeGETApiRegistrations);
module.exports = router;
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Modules</h3><ul><li><a href="module-app.html">app</a></li><li><a href="module-lib_capabilities.html">lib/capabilities</a></li><li><a href="module-lib_deserializeuser.html">lib/deserializeuser</a></li><li><a href="module-lib_localauthentication.html">lib/localauthentication</a></li><li><a href="module-lib_log.html">lib/log</a></li><li><a href="module-lib_modelhelper.html">lib/modelhelper</a></li><li><a href="module-lib_serializeuser.html">lib/serializeuser</a></li><li><a href="module-routes_api.html">routes/api</a></li><li><a href="module-routes_howtoprinttopdf.html">routes/howtoprinttopdf</a></li><li><a href="module-routes_index.html">routes/index</a></li><li><a href="module-routes_login.html">routes/login</a></li><li><a href="module-routes_logout.html">routes/logout</a></li><li><a href="module-routes_popupSchedule.html">routes/popupSchedule</a></li><li><a href="module-routes_popupTranscript.html">routes/popupTranscript</a></li><li><a href="module-routes_profile.html">routes/profile</a></li><li><a href="module-routes_schedule.html">routes/schedule</a></li><li><a href="module-routes_schedulePrint.html">routes/schedulePrint</a></li><li><a href="module-routes_searchMembers.html">routes/searchMembers</a></li><li><a href="module-routes_transcript.html">routes/transcript</a></li><li><a href="module-routes_transcriptPrint.html">routes/transcriptPrint</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 3.6.4</a> on Mon Sep 14 2020 02:31:06 GMT+0000 (Coordinated Universal Time)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
