<%- include header %>
  <div class="container main-body">
    <div class="row">
      <div class="col-12">
        <div class="row">
          <div class="col-1">
          </div>
          <div class="col-10 text-center">
            <button id="btnExportToCsv" class="btn btn-sm btn-3 noprint">Download CSV</button>
            <button onclick="downloadPDF()" class="btn btn-sm btn-3 noprint disabled" style="cursor: not-allowed;" disabled>Download PDF</button>
            <button onclick="print()" class="btn btn-sm btn-3 noprint">Print</button>
          </div>
          <div class="col-1"></div>
       </div>
        <div id="transcriptTableDiv">
          <% var i = 0, count = 0; %>
          <% for(var T=0; T<99; T++) {  %>
          <h1 class="title noDisplay">University of Scouting Transcript</h1>
          <table id="transcriptTable" class="mx-auto table table-hover table-sm table-bordered transcript text-center" style="page-break-after: always;">
            <thead class="thead-dark">
              <th>Course Date</th>
              <th>Course Title</th>
              <th>Credits</th>
              <th>Status</th>
            </thead>
            <tbody>
              <% var count = 0; %>
              <% for(var i=i; i<transcript.length; i++) {  %>
              <tr>
                <td><%= transcript[i].date %></td>
                <td><%= transcript[i].title %></td>
                <td><%= transcript[i].credits %></td>
                <td><%= transcript[i].status %></td>
              </tr>
              <% count++; %>
              <% if(count == 45){count = 0; break;} %>
              <%  } %>
            </tbody>
          </table>
          <% if(i == transcript.length){break;} %>
          <% } %>
        </div>
      </div>
    </div>
  </div>
  <img id="watermark" src="http://localhost:3000/images/LHC_UoS_Logo_Watermark.png" style="display: none; height: 800px; width: 600px;"/>
  <span style="display:none;" id="rowCount"><%= transcript.length+1 %></span>
  <span style="display:none;" id="fname"><%= user.firstName %></span>
  <span style="display:none;" id="lname"><%= user.lastName %></span>
  <span style="display:none;" id="userID"><%= user.memberID %></span>
  <span style="display:none;" id="">
    <table id="transcriptTable-hiddin" class="mx-auto table table-hover table-sm table-bordered transcript text-center">
      <thead class="thead-dark">
        <th>Member ID</th>
        <th>Course Date</th>
        <th>Course Title</th>
        <th>Credits</th>
        <th>Status</th>
      </thead>
      <tbody>
        <% for(var i=0; i<transcript.length; i++) {  %>
        <tr>
          <td><%= transcript[i].memberID %></td>
          <td><%= transcript[i].date %></td>
          <td><%= transcript[i].title %></td>
          <td><%= transcript[i].credits %></td>
          <td><%= transcript[i].status %></td>
        </tr>
        <%  } %>
      </tbody>
    </table>
  </span>
<%- include footer %>
<script src="https://code.jquery.com/jquery-3.5.1.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/1.5.3/jspdf.debug.js" integrity="sha384-NaWTHo/8YCBYJ59830LTz/P4aQZK1sS0SneOgAvhsIl3zBu8r9RevNg5lHCHAuQ/" crossorigin="anonymous"></script>
<script src="https://html2canvas.hertzen.com/dist/html2canvas.js"></script>
<script>
  function downloadPDF() {
    var numRows = document.getElementById("transcriptTable").rows.length;
    var height = numRows * 0.28;
    $('#watermark').css('display','initial');
    html2canvas(document.getElementById('watermark'), { allowTaint: true }).then(
      function(canvas) {
        var imgData = canvas.toDataURL("image/png", 1.0);
        pdf = new jsPDF({ orientation: 'portrait', unit: 'in'});-
        pdf.addImage(imgData, 'JPG', 1.5, 1, 5, 8); //(imgData, image format, left margin, top margin, img width, img hight)
        html2canvas(
          document.getElementById('transcriptTable'), { allowTaint: true }).then(
            function(canvas) {
              var imgData = canvas.toDataURL("image/png", 1.0);
              pdf.addImage(imgData, 'JPG', 1.5, 1.5, 5, height); //(imgData, image format, left margin, top margin, img width, img hight)
              pdf.save();
            }
          );
        }
      );
    $('#watermark').css('display','none');
  }
  
  // function downloadCSV() {
  //   document.querySelector(".buttons-csv").click()
  // }
  function downloadCSV(){

  }
  function print() {
    var sTable = document.getElementById('transcriptTableDiv').innerHTML;
    var rowCount = document.getElementById('rowCount').innerHTML;
    var fname = document.getElementById('fname').innerHTML;
    var lname = document.getElementById('lname').innerHTML;
    var userID = document.getElementById('userID').innerHTML;
    var icon = document.getElementById('Icon');
    var style = "<style>";
    style += '#transcriptTableDiv { width: 8.5in; height: 11in;}';
    style += "table { font: 10px Calibri; margin:0 auto; margin-top:30px; white-space: nowrap;}";
    style += "table, th, td {border: solid 1px #DDD; border-collapse: collapse; padding: 2px 3px;text-align: center;}";
    style += "td { vertical-align: middle;}";
    style += ".title{text-align:center; margin:0 auto; margin-top:20px;}";
    style += ".noprint { display:none;}";
    style += '#watermark1{ width: 100%; position: absolute; top: 0; left: 0; z-index: -1; padding: 0px 1in 0px 1in; margin-top: 100px;}';
    style += '#watermark2{ width: 100%;  position: absolute; top: 0; left: 0; z-index: -1; padding: 0px 1in 0px 1in; margin-top: 1200px;}';
    style += '#watermark3{ width: 100%;  position: absolute; top: 0; left: 0; z-index: -1; padding: 0px 1in 0px 1in; margin-top: 2280px;}';
    style += "</style>";
    var info='', image='', page2=false, page3=false, pageTotal = 1;
    if(rowCount < 46){
      pageTotal = 1;
      page2 = false;
      page3 = false;
    }else if(rowCount < 91){
      pageTotal = 2;
      page2 = true;
      page3 = false;
    }else if(rowCount < 136){
      pageTotal = 3;
      page2 = true;
      page3 = true;
    }
      image += '<img id="watermark1" src="http://localhost:3000/images/LHC_UoS_Logo_Watermark.png" style="height: 800px; width: 650px;"/>';
      info += '<div style="position: absolute; top: 0; right: 0; margin: 10in 1in 1in auto; width: 90%; text-align: right;">Page 1 of '+pageTotal+'</div>';
    if(page2){
      image += '<img id="watermark2" src="http://localhost:3000/images/LHC_UoS_Logo_Watermark.png" style="height: 800px; width: 650px;"/>';
      info += '<div style="position: absolute; top: 0; right: 0; margin: 21in 1in 1in auto !important; width: 90%; text-align: right;">Page 2 of '+pageTotal+'</div>';
    }
    if(page3){ 
      image += '<img id="watermark3" src="http://localhost:3000/images/LHC_UoS_Logo_Watermark.png" style="height: 800px; width: 650px;"/>';
      info += '<div style="position: absolute; top: 0; right: 0; margin: 32.5in 1in 1in auto !important; width: 90%; text-align: right;">Page 3 of '+pageTotal+'</div>';
    }
    info += '<div style="width: 100%; text-align: center; margin-top: 65px; position: absolute; top: 0;">';
    info += 'Member ID: '+userID+' | Name: '+fname+' '+lname+' | '+rowCount+' Records</div>';
    var win = window.open('', '', 'height=700, width=900'); // CREATE A WINDOW OBJECT.
    win.document.write('<html><head><title>Transcript</title>'+style+'</head><body><div id="transcriptTableDiv">'+info+image+sTable+'</div></body></html>');
    win.document.close(); 	// CLOSE THE CURRENT WINDOW.
    win.print();    // PRINT THE CONTENTS.
  }
  
  // $(document).ready(
  //   function() {
  //     //$('#transcriptTable').DataTable( {buttons: ['csvHtml5']});
  //   }
  // );
  // $(document).ready(
  //   function() {
  //     $('.dt-button').addClass('btn btn-sm btn-2');
  //     $('.buttons-csv').css('display','none');
  //     $('#transcriptTable_filter').css('display','none');
  //     $('#transcriptTable_info').css('display','none');
  //     $('#transcriptTable_paginate').css('display','none');
  //   }
  // );
</script>
<script>
  const dataTable = document.getElementById("transcriptTable-hiddin");
  const btnExportToCsv = document.getElementById("btnExportToCsv");

  btnExportToCsv.addEventListener("click", () => {
      const exporter = new TableCSVExporter(dataTable);
      const csvOutput = exporter.convertToCSV();
      const csvBlob = new Blob([csvOutput], { type: "text/csv" });
      const blobUrl = URL.createObjectURL(csvBlob);
      const anchorElement = document.createElement("a");

      anchorElement.href = blobUrl;
      anchorElement.download = "Transcript.csv";
      anchorElement.click();

      setTimeout(() => {
          URL.revokeObjectURL(blobUrl);
      }, 500);
  });
  class TableCSVExporter {
    constructor (table, includeHeaders = true) {
        this.table = table;
        this.rows = Array.from(table.querySelectorAll("tr"));

        if (!includeHeaders && this.rows[0].querySelectorAll("th").length) {
            this.rows.shift();
        }
    }
    convertToCSV () {
        const lines = [];
        const numCols = this._findLongestRowLength();

        for (const row of this.rows) {
            let line = "";

            for (let i = 0; i < numCols; i++) {
                if (row.children[i] !== undefined) {
                    line += TableCSVExporter.parseCell(row.children[i]);
                }

                line += (i !== (numCols - 1)) ? "," : "";
            }

            lines.push(line);
        }

        return lines.join("\n");
    }

    _findLongestRowLength () {
        return this.rows.reduce((l, row) => row.childElementCount > l ? row.childElementCount : l, 0);
    }

    static parseCell (tableCell) {
        let parsedValue = tableCell.textContent;

        // Replace all double quotes with two double quotes
        parsedValue = parsedValue.replace(/"/g, `""`);

        // If value contains comma, new-line or double-quote, enclose in double quotes
        parsedValue = /[",\n]/.test(parsedValue) ? `"${parsedValue}"` : parsedValue;

        return parsedValue;
    }
}
</script>